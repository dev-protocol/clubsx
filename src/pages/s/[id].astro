---
import { whenDefined, whenNotError } from '@devprotocol/util-ts'

const id =
  whenDefined(Astro.params.id, (_id) => _id) ?? new Error('id is missing')

const request = await fetch(
  new URL(`/api/shortify/${id}`, Astro.url.origin),
).catch((err) => new Error(err))

const result = await whenNotError(request, (req) =>
  req.ok
    ? req.json().then((x) => x as { url: string })
    : new Error('Request failed'),
)

const redirect = whenNotError(result, (res) => new URL(res.url))

return redirect instanceof Error
  ? new Response(JSON.stringify({ error: redirect.message }), { status: 404 })
  : Astro.redirect(redirect)
---
