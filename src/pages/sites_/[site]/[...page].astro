---
import {
  type ClubsConfiguration,
  decode,
  pageFactory,
  ClubsPluginSignal,
  type ClubsPropsPages,
} from '@devprotocol/clubs-core'
import { config as _config } from '@fixtures/config'
import PageNotFound from '@pages/404.astro'
import { plugins } from '@constants/plugins'
import ConnectButton from '@components/Wallet/ConnectButton.vue'
import type { DraftOptions } from '@constants/draft'
import PreviewBanner from '@components/PreviewBanner/PreviewBanner.astro'
import Footer from '@components/Footer/Footer.astro'
import { replaceWithFwdHost } from '@fixtures/url'

const { site, page } = Astro.params
const config = await _config(site)

const { getStaticPaths } = pageFactory({
  config: () => Promise.resolve(config),
  plugins,
})
const path = (await getStaticPaths()).find(({ params }) => params.page === page)

const Layout = path?.props.layout
const Content = path?.props.component

const siteBaseUrl = new URL(replaceWithFwdHost(Astro.request)).origin

const decodedConfig = decode<ClubsConfiguration>(config)
const draftOptions = decodedConfig?.options?.find(
  (option) => option.key === '__draft',
)?.value as DraftOptions['value']
const isInDraft = Boolean(draftOptions?.isInDraft)
const fullPage = (path?.props.signals as undefined | string[])?.includes(
  ClubsPluginSignal.DisplayFullPage,
)
---

{
  path && Layout && Content ? (
    <>
      <Layout {...path.props}>
        <span slot="clubs:connect-button">
          <ConnectButton
            client:load
            chainId={decodedConfig.chainId}
            isDisabled={isInDraft}
          />
        </span>

        <Content {...path.props} />

        <PreviewBanner config={decode<ClubsConfiguration>(config)} />
      </Layout>

      <Footer {...(path.props as unknown as ClubsPropsPages)} {fullPage}>
        <a
          slot="page:footer:legal-link"
          href="https://clubs-help.notion.site/Clubs-TERMS-AND-CONDITIONS-804ecd1a5eed4b18a63e67e1a262889c"
          target="_blank"
          rel="noopener"
        >
          Terms and Conditions
        </a>
        <a
          slot="page:footer:legal-link"
          href="https://clubs-help.notion.site/Clubs-Privacy-Policy-9ba96d2a8e0a4a2895cc5ad23b6038da"
          target="_blank"
          rel="noopener"
        >
          Privacy policy
        </a>
      </Footer>
    </>
  ) : (
    <PageNotFound
      redirectionCtaText={`Take me back ${site} homepage`}
      redirectionCtaUrl={siteBaseUrl}
    />
  )
}
