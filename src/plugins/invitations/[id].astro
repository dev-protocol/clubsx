---
import { bytes32Hex, type Membership } from '@devprotocol/clubs-core'
import ClaimButton from './components/ClaimButton.svelte'
import type { Invitation } from './redis-schema'

const fullUrl = Astro.url.pathname
// get the last value of the url
const invitationId = fullUrl.split('/').pop()

const { memberships, baseUrl } = Astro.props as {
  memberships: Membership[]
  baseUrl: string
}

const res = await fetch(
  `${baseUrl}/api/devprotocol:clubs:plugin:invitations/invitations/${invitationId}`,
  // `http://localhost:3000/sites_/pizza/api/devprotocol:clubs:plugin:invitations/invitations/${invitationId}`,
  {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json',
    },
  },
)

if (!res.ok) {
  console.log('in here!')
  return {
    status: 404,
    headers: {
      location: '/404',
    },
  }
}

const invitation = (await res.json()) as Invitation

const membership = memberships.find(
  (m) => bytes32Hex(m.payload) === bytes32Hex(invitation.membership.payload),
)

if (!membership) {
  console.log('no membership!')
  return {
    status: 404,
    headers: {
      location: '/404',
    },
  }
}
---
<div class="bg-white rounded">
  <div class="flex flex-col container mx-auto max-w-sm py-8">
    <div class="p-4 rounded bg-gray-100 mb-4">
      <img class="rounded" src={membership.imageSrc} alt={membership.name} />
    </div>

    <div class="mb-4">
      <ClaimButton {invitation} />
    </div>

    <div class="flex flex-col">
      <h2>{membership.name}</h2>

      <p class="bg-gray-100 rounded p-8 text-black">{membership.description}</p>
    </div>
  </div>
</div>
